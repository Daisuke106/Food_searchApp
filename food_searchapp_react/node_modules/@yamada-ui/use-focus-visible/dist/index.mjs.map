{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { isMac } from \"@yamada-ui/utils\"\nimport { useEffect, useState } from \"react\"\n\ntype Modality = \"keyboard\" | \"pointer\" | \"virtual\"\ntype HandlerEvent = PointerEvent | MouseEvent | KeyboardEvent | FocusEvent\ntype Handler = (modality: Modality, e: HandlerEvent | null) => void\ntype FocusVisibleCallback = (isFocusVisible: boolean) => void\n\nlet hasSetup = false\nlet modality: Modality | null = null\nlet hasEventBeforeFocus = false\nlet hasBlurredWindowRecently = false\n\nconst handlers = new Set<Handler>()\n\nconst trigger = (modality: Modality, ev: HandlerEvent | null) =>\n  handlers.forEach((handler) => handler(modality, ev))\n\nconst onValid = (e: KeyboardEvent) => {\n  return !(\n    e.metaKey ||\n    (!isMac && e.altKey) ||\n    e.ctrlKey ||\n    e.key === \"Control\" ||\n    e.key === \"Shift\" ||\n    e.key === \"Meta\"\n  )\n}\n\nconst onKeyboard = (ev: KeyboardEvent) => {\n  hasEventBeforeFocus = true\n\n  if (onValid(ev)) {\n    modality = \"keyboard\"\n\n    trigger(\"keyboard\", ev)\n  }\n}\n\nconst onPointer = (ev: PointerEvent | MouseEvent) => {\n  modality = \"pointer\"\n\n  if (\n    ev.type === \"mousedown\" ||\n    ev.type === \"pointerdown\" ||\n    ev.type === \"pointerup\"\n  ) {\n    hasEventBeforeFocus = true\n\n    const target = ev.composedPath ? ev.composedPath()[0] : ev.target\n\n    if ((target as HTMLElement).matches(\":focus-visible\")) return\n\n    trigger(\"pointer\", ev)\n  }\n}\n\nconst isVirtualClick = (ev: MouseEvent | PointerEvent): boolean => {\n  if ((ev as any).mozInputSource === 0 && ev.isTrusted) return true\n\n  return ev.detail === 0 && !(ev as PointerEvent).pointerType\n}\n\nconst onClick = (ev: MouseEvent) => {\n  if (!isVirtualClick(ev)) return\n\n  hasEventBeforeFocus = true\n\n  modality = \"virtual\"\n}\n\nconst onFocus = (ev: FocusEvent) => {\n  if (ev.target === window || ev.target === document) return\n\n  if (!hasEventBeforeFocus && !hasBlurredWindowRecently) {\n    modality = \"virtual\"\n\n    trigger(\"virtual\", ev)\n  }\n\n  hasEventBeforeFocus = false\n  hasBlurredWindowRecently = false\n}\n\nconst onBlur = () => {\n  hasEventBeforeFocus = false\n  hasBlurredWindowRecently = true\n}\n\nconst isFocusVisible = () => modality !== \"pointer\"\n\nconst setGlobalFocusEvents = () => {\n  if (typeof window === \"undefined\" || hasSetup) return\n\n  const { focus } = HTMLElement.prototype\n\n  HTMLElement.prototype.focus = function customFocus(...args) {\n    hasEventBeforeFocus = true\n\n    if (this) focus.apply(this, args)\n  }\n\n  document.addEventListener(\"keydown\", onKeyboard, true)\n  document.addEventListener(\"keyup\", onKeyboard, true)\n  document.addEventListener(\"click\", onClick, true)\n\n  window.addEventListener(\"focus\", onFocus, true)\n  window.addEventListener(\"blur\", onBlur, false)\n\n  if (typeof PointerEvent !== \"undefined\") {\n    document.addEventListener(\"pointerdown\", onPointer, true)\n    document.addEventListener(\"pointermove\", onPointer, true)\n    document.addEventListener(\"pointerup\", onPointer, true)\n  } else {\n    document.addEventListener(\"mousedown\", onPointer, true)\n    document.addEventListener(\"mousemove\", onPointer, true)\n    document.addEventListener(\"mouseup\", onPointer, true)\n  }\n\n  hasSetup = true\n}\n\ntype TrackFocusVisibleOptions = {\n  force?: boolean\n}\n\nexport const trackFocusVisible = (\n  func: FocusVisibleCallback,\n  { force }: TrackFocusVisibleOptions = {},\n) => {\n  if (force) hasSetup = false\n\n  setGlobalFocusEvents()\n\n  func(isFocusVisible())\n\n  const handler = () => func(isFocusVisible())\n\n  handlers.add(handler)\n\n  return () => {\n    handlers.delete(handler)\n  }\n}\n\nexport const useFocusVisible = (options?: TrackFocusVisibleOptions) => {\n  const [focusVisible, setFocusVisible] = useState(false)\n  const [focus, setFocus] = useState(false)\n\n  useEffect(() => {\n    return trackFocusVisible(setFocusVisible, options)\n  }, [options])\n\n  return {\n    focusVisible: focusVisible && focus,\n    onFocus: () => setFocus(true),\n    onBlur: () => setFocus(false),\n  }\n}\n"],"mappings":"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","names":["modality"]}